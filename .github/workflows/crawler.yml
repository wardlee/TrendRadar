name: Get Hot News

on:
  schedule:
    - cron: "33 * * * *"
  workflow_dispatch:

permissions:
  contents: write  # v3 需要写权限来更新 html
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码：强制使用 v3.2.0 版本
      # 这是关键！回到那个会自动生成 HTML 的美好时代
      - name: Checkout repository (Downgrade to v3)
        uses: actions/checkout@v4
        with:
          ref: v3.2.0
          fetch-depth: 0

      # 2. 准备 Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # 3. 安装 v3 版本的依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 恢复你的配置 (非常重要)
      # 因为我们切换了代码分支，必须确保你的配置文件还在
      # 如果你的 config 在 Secrets 里最好，如果是在仓库里，v3 结构可能略有不同
      # 这里假设基本的 config.yaml 是兼容的
      - name: Verify config
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "⚠️ Config missing, creating default..."
            cp config/config.example.yaml config/config.yaml || echo "No example found"
          fi

      # 5. 运行爬虫 (v3 会直接修改 index.html)
      - name: Run crawler
        env:
          # v3 不需要复杂的 backend 设置，它默认就生成文件
          GITHUB_ACTIONS: true
        run: python -m trendradar

      # 6. 验证是否生成了新内容 (给你看证据)
      - name: Check Update
        run: |
          echo "查看 index.html 最后修改时间:"
          ls -lh index.html
          echo "查看生成的 txt 文件:"
          ls -R output/ | head -n 10

      # 7. 防止资源屏蔽
      - name: Create .nojekyll
        run: touch .nojekyll

      # 8. 部署
      - name: Fix permissions
        run: |
          chmod -c -R +rX . | while read line; do echo "::warning title=Invalid Permissions Fixed::$line"; done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
