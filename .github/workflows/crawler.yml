name: Get Hot News

on:
  schedule:
    - cron: "33 * * * *"
  workflow_dispatch:

# ğŸ”’ æƒé™è®¾ç½®ï¼šå¿…é¡»èµ‹äºˆ Pages å†™å…¥æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # å°†æŠ“å–å’Œéƒ¨ç½²åˆå¹¶ä¸ºä¸€ä¸ª Job
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify config
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi

      # --- 1. è¿è¡Œçˆ¬è™« ---
      - name: Run crawler
        env:
          # å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿ç”Ÿæˆ output ç›®å½•
          STORAGE_BACKEND: local
          # è¿™é‡Œä¿ç•™ä½ çš„ Secrets å¼•ç”¨ï¼Œå¦‚æœä»¥åä½ è¦é…é£ä¹¦é€šçŸ¥ï¼Œç›´æ¥åœ¨ GitHub åå°åŠ  Secrets å³å¯ç”Ÿæ•ˆ
          # å¦‚æœæ²¡é… Secretsï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡é€šçŸ¥ï¼Œåªç”Ÿæˆæ–‡ä»¶ï¼Œä¸å½±å“ç½‘é¡µæ›´æ–°
          GITHUB_ACTIONS: true
        run: python -m trendradar

      # --- 2. æ£€æŸ¥ç”Ÿæˆç»“æœ (è°ƒè¯•ç”¨) ---
      - name: Check Output
        run: |
          echo "æŸ¥çœ‹ output ç›®å½•å†…å®¹:"
          ls -R output/ || echo "Output directory not found!"

      # --- 3. éƒ¨ç½²åˆ° GitHub Pages (æ ¸å¿ƒæ­¥éª¤) ---
      
      # ä¿®æ­£æƒé™ï¼Œé˜²æ­¢æ–‡ä»¶æ— æ³•è¯»å–
      - name: Fix permissions
        run: |
          chmod -c -R +rX output/ | while read line; do echo "::warning title=Invalid Permissions Fixed::$line"; done

      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼šæ˜ç¡®æŒ‡å®š path ä¸º 'output'
      # è¿™æ„å‘³ç€ output/index.html ä¼šå˜æˆä½ ç½‘ç«™çš„é¦–é¡µ
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'output'

      # æ­£å¼å‘å¸ƒ
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
